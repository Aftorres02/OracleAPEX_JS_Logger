<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logger Test</title>
</head>
<body>
    <h1>Oracle APEX JavaScript Logger Test</h1>
    <div id="test-results"></div>
    <button onclick="runTests()">Run Tests</button>
    <button onclick="clearResults()">Clear Results</button>

    <!-- Mock APEX environment -->
    <script>
        // Mock APEX environment for testing
        window.apex = {
            env: {
                APP_USER: 'TEST_USER',
                APP_PAGE_ID: 1,
                APP_SESSION: 12345,
                APP_ID: 100
            },
            server: {
                process: function(processName, data, options) {
                    console.log('Mock APEX server call:', processName, data);
                    // Simulate success
                    setTimeout(function() {
                        if (options && options.success) {
                            options.success({ status: 'success' });
                        }
                    }, 100);
                }
            }
        };
    </script>

    <!-- Load logger files -->
    <script src="../src/logger-config.js"></script>
    <script src="../src/logger-utils.js"></script>
    <script src="../src/logger.js"></script>

    <script>
        function log(message) {
            const results = document.getElementById('test-results');
            results.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        function runTests() {
            log('=== Starting Logger Tests ===');

            // Test 1: Basic logging
            log('Test 1: Basic logging');
            try {
                namespace.logger.log('Test log message', 'testing');
                namespace.logger.error('Test error message', 'testing');
                namespace.logger.warning('Test warning message', 'testing');
                log('✅ Basic logging works');
            } catch (e) {
                log('❌ Basic logging failed: ' + e.message);
            }

            // Test 2: Level OFF suppression and reset
            log('Test 2: Level OFF suppression and reset');
            try {
                namespace.loggerConfig.configure({ level: 'OFF' });
                namespace.logger.log('This INFORMATION log may be suppressed', 'testing');
                namespace.loggerConfig.configure({ level: 'INFORMATION' }); // Reset
                log('✅ Level OFF set and reset without errors');
            } catch (e) {
                log('❌ Level OFF test failed: ' + e.message);
            }

            // Test 3: Module logger API
            log('Test 3: Module logger API');
            try {
                var modLogger = namespace.logger.createModuleLogger('TestModule');
                modLogger.setExtra({ run: 't3' });
                modLogger.log('Module logger log');
                modLogger.warning('Module logger warning');
                modLogger.error('Module logger error');
                var elapsed0;
                modLogger.timeStart('mod-task');
                setTimeout(function(){ elapsed0 = modLogger.timeStop('mod-task'); }, 10);
                log('✅ Module logger API invoked');
            } catch (e) {
                log('❌ Module logger API failed: ' + e.message);
            }

            // Test 4: Data sanitization
            log('Test 4: Data sanitization');
            try {
                var sensitiveData = {
                    username: 'testuser',
                    password: 'secret123',
                    token: 'abc123token',
                    normal_field: 'normal_value'
                };
                namespace.logger.log('Testing sensitive data', 'testing', sensitiveData);
                log('✅ Data sanitization works (check console for masked data)');
            } catch (e) {
                log('❌ Data sanitization failed: ' + e.message);
            }



            // Test 6: Timing functionality
            log('Test 6: Timing functionality');
            try {
                namespace.logger.timeStart('test_operation');
                setTimeout(function() {
                    var elapsed = namespace.logger.timeStop('test_operation', 'testing');
                    if (elapsed > 0) {
                        log('✅ Timing works: ' + elapsed.toFixed(2) + 'ms');
                    } else {
                        log('❌ Timing returned 0');
                    }
                }, 100);
            } catch (e) {
                log('❌ Timing failed: ' + e.message);
            }

            // Test 7: Configuration validation
            log('Test 7: Configuration validation');
            try {
                var validation = namespace.loggerConfig.validateConfig({
                    level: 'INVALID_LEVEL',          // invalid level
                    maxDataSize: 50,                 // too small
                    maxTimingUnits: 5,               // too small
                    sensitiveFields: 'not-array'     // invalid type
                });
                if (!validation.isValid && validation.errors.length > 0) {
                    log('✅ Configuration validation works');
                } else {
                    log('❌ Configuration validation failed');
                }
            } catch (e) {
                log('❌ Configuration validation failed: ' + e.message);
            }

            // Test 8: Error handling (server failure simulation)
            log('Test 8: Error handling');
            try {
                // Temporarily break APEX server
                var originalProcess = apex.server.process;
                apex.server.process = function() {
                    throw new Error('Server unavailable');
                };
                
                // Use server logging to trigger fallback path
                namespace.logger.logServer('This should fallback to console', 'testing');
                
                // Restore
                apex.server.process = originalProcess;
                log('✅ Error handling works (check console for fallback message)');
            } catch (e) {
                log('❌ Error handling failed: ' + e.message);
            }

            // Test 9: Circular reference handling
            log('Test 9: Circular reference handling');
            try {
                var circularObj = { name: 'test' };
                circularObj.self = circularObj;
                namespace.logger.log('Testing circular reference', 'testing', circularObj);
                log('✅ Circular reference handling works');
            } catch (e) {
                log('❌ Circular reference handling failed: ' + e.message);
            }

            log('=== Tests Completed ===');
        }

        // Auto-run tests when page loads
        window.onload = function() {
            setTimeout(runTests, 1000);
        };
    </script>
</body>
</html>